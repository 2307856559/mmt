<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lemon.web.system.mapper.RoleMapper">
	<parameterMap type="map" id="authorityMap">
		<parameter property="role_id" jdbcType="NUMERIC" javaType="int" />
		<parameter property="list" jdbcType="NULL" javaType="ArrayList" />
	</parameterMap>
	<select id="getRoleList" parameterType="int" resultType="lemon.web.system.bean.Role">
		SELECT A.role_id,A.role_name,A.`status`,A.role_desc,A.sort 
			FROM system_role A 
		WHERE A.`status`='AVAILABLE' 
		ORDER BY A.sort
		<if test="limit!=0">
			 LIMIT #{start},#{limit}
		</if>
	</select>
	<select id="getRsCnt" resultType="int" parameterType="int">
		SELECT count(1) cnt 
			FROM system_role A 
		WHERE A.`status`='AVAILABLE'
	</select>
	<insert id="addRole" parameterType="lemon.web.system.bean.Role" useGeneratedKeys="true" keyProperty="role_id">
		INSERT INTO system_role(role_name,role_desc,status,sort,reloadable) 
			SELECT #{role_name},#{role_desc},#{status},#{sort},#{reloadable}
	</insert>
	<update id="update" parameterType="lemon.web.system.bean.Role">
		UPDATE system_role A 
			SET A.role_name=#{role_name}, 
				A.role_desc=#{role_desc}, 
				A.sort=#{sort}, 
				A.`status`=#{status}, 
				A.reloadable=#{reloadable} 
			WHERE A.role_id=#{role_id}
	</update>
	<update id="batchDelete" parameterType="int">
		UPDATE system_role A
			SET A.`status`='UNAVAILABLE'
		WHERE A.role_id IN 
		<foreach collection="array" item="role_ids" index="index" open="(" separator="," close=")">
			#{role_ids}
		</foreach>
	</update>
	<select id="getRole" parameterType="int" resultType="lemon.web.system.bean.Role">
		SELECT A.role_id,A.role_name,A.`status`,A.role_desc,A.sort 
			FROM system_role A WHERE A.role_id=#{role_id}
	</select>
	<select id="checkRoleName" parameterType="string" resultType="int">
		SELECT count(1) cnt
			FROM system_role A 
		WHERE A.role_name=#{role_name} 
			AND A.`status`='AVAILABLE'
	</select>
	<delete id="deleteRoleAuthority" parameterType="int">
		DELETE FROM system_role_menu WHERE role_id=#{role_id}
	</delete>
	<insert id="setDefaultRoleAuthority" parameterType="int">
		INSERT INTO system_role_menu(role_id,menu_id) 
			SELECT A.role_id,A.menu_id
		FROM system_role_menu_default A
			WHERE A.role_id=#{role_id}
	</insert>
	<insert id="setRoleAuthority" parameterMap="authorityMap">
		INSERT INTO system_role_menu(role_id,menu_id) 
			SELECT #{role_id},menu_code
				FROM system_menu A 
			WHERE a.menu_code IN 
		<foreach collection="list" item="list" index="index" open="(" separator="," close=")">
			#{list}
		</foreach>
	</insert>
	<select id="getAuthority" parameterType="int" resultType="lemon.web.system.bean.Menu">
		SELECT a.menu_id,a.menu_name,a.menulevcod,a.supmenucode,a.menuico,b.menu_id  authority
        	from system_menu a        
        		left join system_role_menu b on a.menu_id=b.menu_id and b.role_id=#{role_id}
			where a.menu_id != 0
		order by a.menulevcod,a.sort
	</select>
	<update id="updateReload" parameterType="int">
		UPDATE system_role A 
			SET a.reloadable='UNAVAILABLE' 
		WHERE A.role_id=#{role_id}
	</update>
</mapper>